<style>
.hs--content--success {   display: flex !important; align-items: center;}
     .coupontext span img {    margin-bottom: 1px;}
     .coupon p { margin: 0;font-size: 13px;}
    @media only screen and (max-width: 360px) {
     .coupon p { margin: 0;font-size: 12px;} 
    }
    .hs-content-discount-add {visibility: hidden; height: 0;}
    .hs-content-discount-add.active {visibility: visible;height: auto;}
    .hs-add-discount{border-top:0!important;}
    .hs-add-discount:after{display:none;}
    .coupon-container-heading{    
    font-size: 14px;
    font-family: AvenirRegular;
    }
    .coupon.activecodestrip button { 
    border: 1px solid #62bd81;
    color: #62bd81; 
}
    button.applycode-trigger {  font-weight: 800;  min-width: 50px;}
    .coupontext {    display: flex;font-family:'AvenirRegular'!important;align-items: center;}
   .dropdown-header-heading img,.coupontext span {margin:1px;margin-right:4px;}
    .coupon-container {margin-top: 20px;
      display: flex;
      flex-direction: column;
      width: 100%;
    padding: 0 0px;     
    }
    .customer-info {margin-bottom: 20px;}
    .customer-info p {margin: 5px 0;font-size: 14px;}
   .coupon.warningcodestrip  .offer-added,.coupon:not(.activecodestrip) .offer-added{display:none;}
  .coupon.warningcodestrip .offer-code,.coupon:not(.warningcodestrip) .offer-error,.coupon:not(.warningcodestrip).activecodestrip .offer-code{display:none;}
    .coupon {     
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }    
    .coupon button {font-family:'AvenirRegular'!important;
      border-radius:4px;
       background-color: #ffffff; 
      border:1px solid #FF805A;      
      color:#FF805A;font-size:10px;     
      padding: 5px 5px;
      cursor: pointer;
    }
    .dropdown-header {
      cursor: pointer;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;    
      margin-bottom: 10px;
    }
    span.dropdown-header-heading {font-family:'AvenirRegular'!important; display: flex;align-items: center;}
    .dropdown-header-heading img{object-fit:contain;max-width: 18px;max-height: 18px;}
    .dropdown-header .dropdown-arrow { transform:rotate(0deg); transition: transform 0.3s ease;}
    .dropdown-header.active .dropdown-arrow {transform: rotate(180deg);}
    .dropdown-content {display: none;flex-direction: column;}
    .dropdown-content.active { display: flex;}
    .coupon-input {margin-top: 20px;}
    .hidden {display: none;}
    .visible { display: inline-block;}

</style>
<div id="discount-grid-drawer" class="coupon-container"> 
{% if settings.discount-title!= blank %}<span class="coupon-container-heading">{{ settings.discount-title }}</span>{% endif %}
  <!-- Collapsible Coupons Section -->
    <div class="dropdown-header" onclick="toggleDropdown(this)">
      <span class="dropdown-header-heading"><img src="{{'coupon-code.svg'|asset_url }}" alt="customer discounttag" width="18px" height="18px">Have another coupon?</span><span><img class="dropdown-arrow" src="{{'dropdown-arrow.svg'|asset_url }}" alt="dropdown arrrow" width="18px" height="18px"></span>
    </div>
    <div class="dropdown-content">
    <!-- Static Coupons Section -->
     {% if settings.show_discount2 %}
    <div class="coupon">
     <div class="coupontext"><span><img  class="offer-code" src="{{ 'offer-code.svg' |asset_url }}" alt="discounttag" width="18px" height="18px">
       <img  class="offer-added" src="{{ 'offer-added.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"> <img  class="offer-error" src="{{ 'Alert icon.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"></span>  
       <p>{{settings.coupon_detail2 | strip}}</p></div>     
      <button class="applycode-trigger" onclick="setCouponCode('{{settings.coupon_name2 | strip}}', this)" data-code="{{settings.coupon_name2 | strip}}">Apply</button>
     
    </div>
    {% endif %}
    {% if settings.show_discount %}
    <div class="coupon">
     <div class="coupontext"><span><img  class="offer-code" src="{{ 'offer-code.svg' |asset_url }}" alt="discounttag" width="18px" height="18px">
      <img  class="offer-added" src="{{ 'offer-added.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"><img  class="offer-error" src="{{ 'Alert icon.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"></span> 
       <p>{{settings.coupon_detail1| strip}}</p></div>
      <button class="applycode-trigger" onclick="setCouponCode('{{settings.coupon_name | strip}}', this)" data-code="{{settings.coupon_name | strip}}">Apply</button>
    </div>
      {% endif %}
    <!-- Collapsible Coupons Section -->
 
  
        {% if settings.show_discount3 %} 
      <div class="coupon">
      <div class="coupontext"><span><img  class="offer-code" src="{{ 'offer-code.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"><img  class="offer-added" src="{{ 'offer-added.svg' |asset_url }}" alt="discounttag" width="18px" height="18px">
       <img  class="offer-error" src="{{ 'Alert icon.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"></span>  
        <p>{{settings.coupon_detail3 | strip}}</p></div>
        <button class="applycode-trigger" onclick="setCouponCode('{{settings.coupon_name3 | strip}}', this)" data-code="{{settings.coupon_name3 | strip}}">Apply</button>
      </div>
        {% endif %}
        
      {% if settings.show_discount-meta and customer.metafields.custom.discount_coupon %}
      <div class="coupon">
       <div class="coupontext"><span><img  class="offer-code" src="{{ 'offer-code.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"><img  class="offer-added" src="{{ 'offer-added.svg' |asset_url }}" alt="discounttag" width="18px" height="18px">
        <img  class="offer-error" src="{{ 'Alert icon.svg' |asset_url }}" alt="discounttag" width="18px" height="18px"></span> 
        <p>{{settings.coupon_detailmeta | strip}}&nbsp<strong>{{customer.metafields.custom.discount_coupon | strip }}</strong></p></div>
        <button class="applycode-trigger" onclick="setCouponCode('{{customer.metafields.custom.discount_coupon | strip}}', this)" data-code="{{customer.metafields.custom.discount_coupon | strip}}">Apply</button>
      </div>
        
    {% endif %}
  
<div class="cart-sidebar-discount">
  <span id="applied-discount-code">
  
  
    <span class="applied-discount-code-wrapper">
      {% render 'discount-tag-icon' %}
      <span class="applied-discount-code-value"></span>
      <button id="clear-discount-btn">X</button>
    </span>
  </span>
  <small id="discount-code-error"></small>
  <div class="dis-inputs-fields">
  <input type="text" id="discount-code-input" autocomplete="on" value="" placeholder="Enter Discount Code">
  <button id="apply-discount-btn">APPLY</button>
  </div>
  {% if settings.discount-note!= blank %}<span class="coupon-container-heading">{{ settings.discount-note }}</span>{% endif %}
</div>
   
  </div>
  </div>

<script>
  //
 var shopcurrency = '{{ shop.currency }}';
  if (shopcurrency === 'INR') {
      shopcurrency = 'â‚¹';
  }
 // console.log(shopcurrency);
  //togglebutton button
  function toggleDropdown(header) {
    const content = header.nextElementSibling;
    header.classList.toggle('active');
    content.classList.toggle('active');
     var discontent = document.querySelector('.hs-content-discount-add');
    discontent.classList.toggle('active');
}
  //
document.addEventListener("DOMContentLoaded", function(event) { 
  let clearBtn = document.querySelector("#clear-discount-btn");
  let applyBtn = document.querySelector("#apply-discount-btn");
  let discountCodeError = document.querySelector("#discount-code-error");
  let discountCodeWrapper = document.querySelector("#applied-discount-code .applied-discount-code-wrapper");
  let discountCodeValue = document.querySelector("#applied-discount-code .applied-discount-code-value");
  let discountCodeInput = document.querySelector("#discount-code-input");
  let totalCartSelector = document.querySelector(".tt-cart-total-price"); // Total Cart Selector to update the total amount. 
  let authorization_token;
  
  let checkoutContainer = document.createElement('div');
  document.body.appendChild(checkoutContainer);

  if (localStorage.discountCode) applyDiscount( JSON.parse(localStorage.discountCode).code);
  if(applyBtn)
  applyBtn.addEventListener("click", function(e){
    e.preventDefault()
    applyDiscount(discountCodeInput.value.trim());    
  });

  if(clearBtn)
  clearBtn.addEventListener("click", function(e){
    e.preventDefault()
    clearDiscount();   
  });

  function clearDiscount() {
    discountCodeValue.innerHTML = "";
    discountCodeError.innerHTML = "";
    clearLocalStorage();
    fetch("/discount/CLEAR");
  }

  function clearLocalStorage() {
    if(discountCodeWrapper) discountCodeWrapper.style.display = "none";
    if(totalCartSelector) totalCartSelector.innerHTML = JSON.parse(localStorage.discountCode).totalCart;
    localStorage.removeItem("discountCode");
  }

  function applyDiscount(code) {
    //

    //
    if(applyBtn) {
      applyBtn.innerHTML = "APPLYING <div class='loader'></div>";
      applyBtn.style.pointerEvents = "none";
    }
    fetch("/payments/config", {"method": "GET"})
    .then(function(response) { return response.json() })
    .then(function(data) {
        const checkout_json_url = '/wallets/checkouts/';
        authorization_token = btoa(data.paymentInstruments.accessToken)
        fetch('/cart.js', {}).then(function(res){return res.json();})
        .then(function(data){

        let body = {"checkout": { "country": Shopify.country,"discount_code": code,"line_items": data.items, 'presentment_currency': Shopify.currency.active } }
        fetch(checkout_json_url, {
          "headers": {
            "accept": "*/*", "cache-control": "no-cache",
            "authorization": "Basic " + authorization_token,
            "content-type": "application/json, text/javascript",
            "pragma": "no-cache", "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors", "sec-fetch-site": "same-origin"
          },
          "referrerPolicy": "strict-origin-when-cross-origin",
          "method": "POST", "mode": "cors", "credentials": "include",
          "body": JSON.stringify(body)
      })
      .then(function(response) { return response.json() })
      .then(function(data) {
        console.log(data.checkout);
        if(data.checkout && data.checkout.applied_discounts.length > 0){
          let discountApplyUrl = "/discount/"+code+"?v="+Date.now()+"&redirect=/checkout/";
          fetch(discountApplyUrl, {}).then(function(response) { return response.text(); })
          if(discountCodeWrapper) discountCodeWrapper.style.display = "flex";
          if(discountCodeError) discountCodeError.innerHTML = "";
          if(discountCodeValue) discountCodeValue.innerHTML = data.checkout.applied_discounts[0].title + " (" + data.checkout.applied_discounts[0].amount + ' ' + Shopify.currency.active + ")";
          let localStorageValue = {
            'code': code.trim(),
            'totalCart': data.checkout.total_line_items_price
          };
          localStorage.setItem("discountCode", JSON.stringify(localStorageValue));
          if(totalCartSelector) totalCartSelector.innerHTML = "<s>" +shopcurrency + data.checkout.total_line_items_price + "</s>" +shopcurrency + data.checkout.total_price;
           //
           let appliedCodeTitle = data.checkout.applied_discounts[0].title.trim(); // Get the trimmed discount title
           let inputCode =code.trim(); // input trimmed values
            successDiscount(inputCode, appliedCodeTitle);
          //
        }else{
          //
          let inputCode = code.trim(); // input trimmed values
           warningDiscount(inputCode);
          //
          if(discountCodeValue) discountCodeValue.innerHTML = "";
          clearLocalStorage();
          if(discountCodeError) discountCodeError.innerHTML = "Please Enter Valid Coupon Code."
        }
      }).finally(function(params) {
        if(applyBtn){
          applyBtn.innerHTML = "APPLY";
          applyBtn.style.pointerEvents = "all";
        }
    });
    });
  });
}
  // Define the global function
function successDiscount(inputCode, appliedCodeTitle) {
    // Handle the success logic here
    console.log("success input code applied:", inputCode);
    console.log("success title:", appliedCodeTitle);

    // Check if inputCode and appliedCodeTitle are the same
    if (inputCode === appliedCodeTitle) {
            
        // Find the button with data-code same as appliedCodeTitle
        const successCodeTrigger = document.querySelector(`.applycode-trigger[data-code="${appliedCodeTitle}"]`);
        
        if (successCodeTrigger) {
            // Update the UI elements
            successCodeTrigger.classList.remove('warningactive');
            successCodeTrigger.textContent = 'Applied';
            successCodeTrigger.disabled = true;
            successCodeTrigger.closest('.coupon').classList.remove('warningcodestrip');
            successCodeTrigger.closest('.coupon').classList.add('activecodestrip');
        }
    }
}

function warningDiscount(inputCode) {
  // Handle the success logic here
  console.log("warniingi code applied:", inputCode);
  
   const warningCodeTrigger = document.querySelector(`.applycode-trigger[data-code="${inputCode}"]`);
        
        if (warningCodeTrigger) {
            // Update the UI elements
            warningCodeTrigger.classList.remove('warningactive');
            warningCodeTrigger.textContent = 'Applied';
            warningCodeTrigger.disabled = true;
            warningCodeTrigger.closest('.coupon').classList.add('warningcodestrip');
            warningCodeTrigger.closest('.coupon').classList.remove('activecodestrip');
        }
  // You can add more logic here as needed
}
  //
});

  ////drawer select and apply code

function setCouponCode(code, button) {
    resetOtherButtons(button);
  // Set the value of the discount code input field  
  const discountInput = document.getElementById('discount-code-input');
  discountInput.value = code;
 
  // Trigger the click event on the "APPLY" button
  const applyButton = document.getElementById('apply-discount-btn');
  applyButton.click();
}
//
  //reset values
  function resetOtherButtons(currentButton) {
    document.querySelectorAll('.applycode-trigger').forEach(otherButton => {
        if (otherButton !== currentButton) {
            otherButton.textContent = 'Apply';
            otherButton.disabled = false;
            otherButton.closest('.coupon').classList.remove('activecodestrip');
            otherButton.classList.remove('warningactive');
            otherButton.closest('.coupon').classList.remove('warningcodestrip');
        }
    });
}
  document.querySelectorAll('.applycode-trigger').forEach(button => {
    button.addEventListener('click', () => {
        resetOtherButtons(button);
        // Add any additional logic here for when a button is clicked
    });
});
  document.getElementById('apply-discount-btn').addEventListener('click', function() {
    resetOtherButtons(this); 
    // Additional logic for applying the discount can go here
});

// Clear button click event
document.getElementById('clear-discount-btn').addEventListener('click', function() {
     resetOtherButtons(this); 
    // Additional logic for clearing the discount can go here
});
//
 


</script>